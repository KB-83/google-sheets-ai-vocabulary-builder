<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      /* Basic CSS for the dialog look */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
      }
      body {
        font-family: 'Inter', sans-serif;
        background-color: #f0f2f5;
        display: flex;
        box-sizing: border-box;
        padding: 10px;
      }
      
      #review-container {
        background-color: #ffffff;
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        padding: 20px;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center; /* Center content (like loading text) by default */
        position: relative; /* Needed for settings button positioning */
      }
      
      /* --- State Management --- */
      #loading, #error-message, #no-words-message, #word-card, #session-complete {
        display: none;
      }
      #review-container.is-loading #loading,
      #review-container.has-error #error-message,
      #review-container.is-empty #no-words-message,
      #review-container.is-reviewing #word-card,
      #review-container.is-complete #session-complete {
        display: flex;
      }
      
      #word-card, #session-complete {
        width: 100%;
        height: 100%;
        flex-direction: column;
        align-items: center;
        scroll-behavior: auto;
      }
      
      /* --- Progress Counter Styling --- */
      #progress-counter {
        background-color: #e3f2fd;
        color: #1976d2;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: 600;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
      }

      #word-card.is-initial .metadata-controls {
        display: none;
      }
      
      /* --- Styling for the initial centered view --- */
      #word-card.is-initial {
        justify-content: center;
      }
      #word-card.is-initial #word-header {
        flex-direction: column;
        border-bottom: none;
        padding-bottom: 0;
        margin-bottom: 0;
      }

      #word-card.is-initial #show-answer-group {
        border-top: none;
        padding-top: 0;
        margin-top: 20px;
      }
      #word-card.is-initial #answer-display,
      #word-card.is-initial #srs-buttons {
        scroll-behavior: auto;
        display: none;
      }

      .pos-header {
        margin-top: 15px; margin-bottom: 8px; font-size: 1.1em;
        color: #3f51b5; border-bottom: 1px solid #e0e0e0; padding-bottom: 4px;
      }
      .pos-header-small {
        margin-top: 10px; margin-bottom: 5px; font-size: 0.9em;
        font-weight: 600; color: #5f6368;
      }
      .persian-example {
        direction: rtl; text-align: right; font-family: 'Vazirmatn', 'Tahoma', sans-serif;
        color: #000000; font-weight: 400; margin-top: 4px; font-size: 1.0em;
      }

      /* --- Styling for the detailed review view --- */
      #word-card:not(.is-initial) #show-answer-group {
        display: none;
      }

      #word-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        border-bottom: 1px solid #e0e0e0;
        padding-bottom: 15px;
        margin-bottom: 15px;
        flex-shrink: 0;
      }
      
      #word-display {
        font-size: 2.2em;
        font-weight: 600;
        color: #3f51b5;
        word-break: break-word;
        margin: 0;
      }
      
      /* This is the base style, without any height limits or alignment. */
      #pronunciation-group {
        display: flex;                  /* ADD THIS: Turns the container into a flexbox */
        flex-direction: column;         /* ADD THIS: Stacks the items vertically */
        gap: 1px;                       /* ADD THIS: Adds a small space between each entry */
        font-size: 0.7em;
        color: #5f6368;
        padding-left: 10px;
        transition: max-height 0.4s ease;
      }

      /* This style applies ONLY to the INITIAL view to center the text. */
      #word-card.is-initial #pronunciation-group {
        text-align: center;
        margin-top: 10px;
      }
      #word-card.is-initial #pronunciation-group span {
        justify-content: center;
      }
      
      /* This style applies ONLY to the REVEALED view to make the box scrollable. */
      #word-card:not(.is-initial) #pronunciation-group {
        max-height: 55px;
        overflow-y: auto;
        overflow-x: hidden;
        text-align: right;
      }
      #word-card:not(.is-initial) #pronunciation-group span {
        justify-content: flex-end;
      }
      #answer-display {
        font-size: 0.85em;
        color: #333;
        line-height: 1.6;
        text-align: left;
        flex-grow: 1;
        overflow-y: auto;
        width: 100%;
        padding-right: 15px;
        box-sizing: border-box;
        scroll-behavior: auto;
      }
      
      .button-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        margin-top: 15px; 
        width: 100%;
        flex-shrink: 0;
        padding-top: 15px;
      }

      #show-answer-group {
        justify-content: center;
      }

      #srs-buttons {
        border-top: 1px solid #e0e0e0;
        justify-content: space-between;
      }

      .srs-main-controls, .srs-side-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
      }
      
      button {
        padding: 10px 18px;
        border: none;
        border-radius: 8px;
        font-size: 0.9em;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        font-weight: 500;
        min-width: 90px;
        line-height: 1.2;
      }
      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      }
      #show-answer-btn, #play-scramble-btn {
        background-color: #2e7d32;
        color: white;
      }
      #show-answer-btn:hover, #play-scramble-btn:hover {
        background-color: #1b5e20;
      }
      .srs-btn {
        color: white;
      }
      .srs-btn small {
        display: block;
        font-size: 0.8em;
        margin-top: 3px;
        opacity: 0.8;
      }
      #again-btn { background-color: #d32f2f; }
      #again-btn:hover { background-color: #b71c1c; }
      #hard-btn { background-color: #f57c00; }
      #hard-btn:hover { background-color: #e65100; }
      #good-btn { background-color: #1976d2; }
      #good-btn:hover { background-color: #0d47a1; }
      #easy-btn { background-color: #7b1fa2; }
      #easy-btn:hover { background-color: #4a148c; }

      #manual-days-input {
        width: 50px;
        padding: 9px;
        border: 1px solid #ccc;
        border-radius: 8px;
        text-align: center;
        font-size: 0.9em;
      }
      #manual-set-btn {
        min-width: 60px;
        background-color: #546e7a;
        color: white;
      }
       #manual-set-btn:hover {
        background-color: #37474f;
      }

      .play-button, .tts-button {
        background: none;
        border: none;
        width: 20px;
        height: 20px;
        padding: 0;
        margin: 0 0 0 8px;
        cursor: pointer;
        transition: transform 0.2s;
        min-width: auto;
        box-shadow: none;
        vertical-align: middle;
      }
      .play-button:hover, .tts-button:hover {
        transform: scale(1.2);
      }
      .play-button-uk, .tts-button { color: #1976d2; }
      .play-button-us { color: #d32f2f; }
      
      .meaning-block {
        background-color: #f7f9fc;
        border-left: 3px solid #1976d2;
        padding: 10px 12px;
        margin-bottom: 12px;
        border-radius: 0 8px 8px 0;
      }
      .meaning-block p {
        margin: 0;
        padding: 0;
        line-height: 1.4;
      }
      .meaning-block .definition {
        font-weight: 500;
        color: #202124;
      }
      .meaning-block .example {
        font-style: normal; /* Changed from italic */
        color: #202124;    /* Changed from grey to a solid dark color */
        margin-top: 4px;
      }
      .meaning-block .persian {
        direction: rtl;
        text-align: right;
        font-family: 'Vazirmatn', 'Tahoma', 'Arial', sans-serif;
        color: #00695c;
        font-weight: 500;
        margin-top: 6px;
        font-size: 1.1em;
      }

      .meaning-block .examplep {
        direction: rtl;
        text-align: right;
        font-family: 'Vazirmatn', 'Tahoma', 'Arial', sans-serif;
        color: #000000;    /* Changed from teal to solid black */
        font-weight: 500;
        margin-top: 6px;
        font-size: 1.0em;     /* Reduced from 1.1em */
      }

      hr {
        border: none;
        border-top: 1px solid #e0e0e0;
        margin: 15px 0;
      }
      .dictionary-links {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #e0e0e0;
        text-align: center;
      }
      .dictionary-links a {
        display: inline-flex;
        align-items: center;
        text-decoration: none;
        color: #5f6368;
        background-color: #f7f9fc;
        padding: 8px 12px;
        border-radius: 20px;
        margin: 0 5px;
        font-size: 0.9em;
        transition: all 0.2s ease;
      }
      .dictionary-links a:hover {
        background-color: #e3f2fd;
        color: #1976d2;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .dictionary-links span {
        margin-left: 6px;
      }
      #session-complete {
        justify-content: center;
        text-align: center;
      }
      #review-more-btn {
        background-color: #0d47a1;
        color: white;
        margin-top: 15px;
      }
      #review-more-btn:hover {
        background-color: #0b3a7d;
      }
      .add-word-btn {
        margin-left: 8px;
        padding: 2px 8px;
        font-size: 0.8em;
        cursor: pointer;
        border-radius: 4px;
        border: 1px solid #90a4ae;
        background-color: #eceff1;
        color: #37474f;
        font-weight: 500;
        min-width: auto;
        box-shadow: none;
      }
      .add-word-btn:hover {
        background-color: #cfd8dc;
      }
      .add-word-btn:disabled {
        cursor: not-allowed;
        background-color: #e8f5e9;
        color: #2e7d32;
        border-color: #a5d6a7;
      }
      .toast {
        position: fixed;
        bottom: -100px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #333;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        transition: bottom 0.5s ease;
        z-index: 1000;
      }
      .toast.show {
        bottom: 20px;
      }

      #settings-btn {
        width: 24px;
        height: 24px;
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
        opacity: 0.6;
        transition: opacity 0.2s;
        min-width: auto;
        box-shadow: none;
        margin-left: 8px;
      }
      #settings-btn:hover {
        opacity: 1;
        transform: none;
        box-shadow: none;
      }
      #settings-modal {
        display: none;
        position: fixed;
        z-index: 1001;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
        align-items: center;
        justify-content: center;
      }
      .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 20px;
        border: 1px solid #888;
        border-radius: 12px;
        width: 80%;
        max-width: 500px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      }
      .modal-content h2 {
        margin-top: 0;
      }
      #voice-selector {
        width: 100%;
        padding: 8px;
        margin-top: 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
      }
      .close-btn {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }
      .metadata-controls {
        display: flex;
        justify-content: space-around;
        align-items: center;
        width: 100%;
        padding: 10px 0;
        margin-bottom: 15px;
        background-color: #f7f9fc;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
      }
      .metadata-controls label { display: flex; align-items: center; cursor: pointer; }
      .metadata-controls input[type="checkbox"] { margin-right: 5px; width: 16px; height: 16px; }
      .metadata-controls select { margin-left: 5px; padding: 4px; border-radius: 4px; border: 1px solid #ccc; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">

  </head>
  <body>
    <div id="review-container" class="is-loading">
      <div id="loading">Loading words...</div>
      <div id="error-message"></div>
      <div id="no-words-message">No words due for review today. Great job!</div>

      <div id="word-card" class="hidden">
        <div id="word-header">
            <div id="word-display"></div>
            <div id="pronunciation-group"></div>
        </div>
        <div class="metadata-controls">
              <label><input type="checkbox" id="writing-cb"> Writing</label>
              <label><input type="checkbox" id="speaking-cb"> Speaking</label>
              <label>Difficulty: 
                  <select id="difficulty-select">
                      <option value="0">Not Set</option>
                      <option value="1">⭐</option>
                      <option value="2">⭐⭐</option>
                      <option value="3">⭐⭐⭐</option>
                      <option value="4">⭐⭐⭐⭐</option>
                      <option value="5">⭐⭐⭐⭐⭐</option>
                  </select>
              </label>
          </div>
        <div id="answer-display">
        </div>
        <div class="button-group" id="show-answer-group">
          <button id="show-answer-btn">Show Answer</button>
          <!-- <button id="play-scramble-btn">Play Scramble</button> -->
        </div>
        <div id="srs-buttons" class="button-group">
          <div class="srs-main-controls">
            <button id="again-btn" class="srs-btn">Again</button>
            <button id="hard-btn" class="srs-btn">Hard</button>
            <button id="good-btn" class="srs-btn">Good</button>
            <button id="easy-btn" class="srs-btn">Easy</button>
            <input type="number" id="manual-days-input" min="1" placeholder="Days">
            <button id="manual-set-btn">Set</button>
          </div>
          <div class="srs-side-controls">
            <div id="progress-counter">0 / 0</div>
            <button id="settings-btn" title="TTS Settings">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.44,0.17-0.48,0.41L9.15,5.25C8.56,5.5,8.03,5.82,7.53,6.2L5.14,5.24C4.92,5.16,4.67,5.24,4.55,5.45L2.63,8.77 c-0.11,0.2-0.06,0.47,0.12,0.61l2.03,1.58C4.74,11.36,4.72,11.68,4.72,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.48,2.44 c0.04,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.48-0.41l0.48-2.44c0.59-0.24,1.12-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.11-0.2,0.06-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"></path></svg>
            </button>
          </div>
        </div>
      </div>
      
      <div id="session-complete">
        <h2>Review Complete!</h2>
        <p>You've finished all your scheduled words for today.</p>
        <button id="review-more-btn">Review 10 More Words</button>
      </div>
    </div>

    <div id="settings-modal">
      <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2>TTS Voice Settings</h2>
        <p>Select a voice for reading examples aloud. Your choice will be saved in this browser.</p>
        <select id="voice-selector"></select>
      </div>
    </div>

    <script>
      const sampleWords = [
        {
          word: "Ebullient",
          row: 2,
          reviewCount: 1,
          totalReviews: 2,
          ukPronunciation: "/ɪˈbʌl.i.ənt/",
          usPronunciation: "/ɪˈbʊl.jənt/",
          partOfSpeech: "adjective",
          definitions: ["Cheerful and full of energy.", "Boiling or agitated as if boiling."],
          persianTranslations: ["شاد و پر انرژی", "جوشان"],
          definitionExamples: ["She sounded ebullient and happy.", "The ebullient waters of the hot spring."],
          generalExamples: [],
          synonyms: "exuberant\nbuoyant\nchipper",
          antonyms: "depressed\nsullen",
          notes: "Comes from the Latin 'ebullire', meaning 'to boil over'.",
          wordFamily: "ebullience (noun)",
          cambridgeUrl: "https://dictionary.cambridge.org/dictionary/english/ebullient",
          oxfordUrl: "https://www.oxfordlearnersdictionaries.com/definition/english/ebullient"
        },
        {
          word: "Serendipity",
          row: 3,
          reviewCount: 0,
          totalReviews: 0,
          ukPronunciation: "/ˌser.ənˈdɪp.ə.ti/",
          usPronunciation: "/ˌser.ənˈdɪp.ə.t̬i/",
          partOfSpeech: "noun",
          definitions: ["The occurrence and development of events by chance in a happy or beneficial way."],
          persianTranslations: ["خوش‌اقبالی", "کشف غیرمنتظره"],
          definitionExamples: ["Our meeting was pure serendipity."],
          generalExamples: [],
          synonyms: "fluke\nchance\nhappy accident",
          antonyms: "misfortune\nbad luck",
          notes: "Coined by Horace Walpole in 1754.",
          wordFamily: "serendipitous (adjective)",
          cambridgeUrl: "https://dictionary.cambridge.org/dictionary/english/serendipity",
          oxfordUrl: "https://www.oxfordlearnersdictionaries.com/definition/english/serendipity"
        }
      ];

      let wordsToReview = [];
      let currentWordIndex = 0;
      let totalWordsInSession = 0;
      let reviewedWords = 0;
      const reviewContainer = document.getElementById('review-container');
      let voices = [];
      const speakerIconSvg = `<svg viewBox="0 0 24 24" fill="currentColor" style="display: block; width: 100%; height: 100%;"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg>`;
      const VOICE_STORAGE_KEY = 'preferredTTSVoice';

      function updateProgressCounter() {
        const progressCounter = document.getElementById('progress-counter');
        progressCounter.textContent = `${reviewedWords} / ${totalWordsInSession}`;
      }

      function playAudio(url) {
        const audio = new Audio(url);
        audio.play().catch(e => console.error("Error playing audio:", e));
      }

      function getVoices() {
        voices = window.speechSynthesis.getVoices();
        populateVoiceList();
      }

      /**
       * **NEW**: Parses a string that contains multi-part-of-speech data.
       * @param {string} dataString The raw string from the sheet cell.
       * @returns {Array<Object>} An array of objects, e.g., [{pos: 'NOUN', items: ['• item 1', '• item 2']}]
       */
      function parseMultiPartSpeechData(dataString) {
        if (!dataString || !dataString.includes('---')) {
          return [{ pos: null, items: (dataString || '').split('\n').filter(Boolean) }];
        }

        const sections = dataString.split(/\n\n?--- /);
        const result = [];

        sections.forEach(section => {
          if (section.trim()) {
            const lines = section.split('\n');
            const header = lines.shift().replace(/ ---/g, '').trim();
            const items = lines.filter(line => line.trim());
            result.push({ pos: header, items: items });
          }
        });

        return result;
      }

      
      function populateVoiceList() {
        const voiceSelector = document.getElementById('voice-selector');
        const savedVoice = localStorage.getItem(VOICE_STORAGE_KEY);
        voiceSelector.innerHTML = '';
        voices.forEach(voice => {
          if (voice.lang.startsWith('en-')) {
            const option = document.createElement('option');
            option.textContent = `${voice.name} (${voice.lang})`;
            option.setAttribute('data-lang', voice.lang);
            option.setAttribute('data-name', voice.name);
            if (voice.name === savedVoice) {
              option.selected = true;
            }
            voiceSelector.appendChild(option);
          }
        });
      }

      function speakText(text) {
        if ('speechSynthesis' in window) {
          window.speechSynthesis.cancel();
          const utterance = new SpeechSynthesisUtterance(text);
          const savedVoiceName = localStorage.getItem(VOICE_STORAGE_KEY);
          let selectedVoice = null;

          if (savedVoiceName) {
            selectedVoice = voices.find(voice => voice.name === savedVoiceName);
          }
          
          if (!selectedVoice) {
            const voicePriority = ["Google US English", "Microsoft Zira - English (United States)", "Samantha"];
            for (const voiceName of voicePriority) {
              selectedVoice = voices.find(voice => voice.name === voiceName);
              if (selectedVoice) break;
            }
          }
          if (!selectedVoice) {
            selectedVoice = voices.find(voice => voice.lang.startsWith('en-US') && voice.localService);
          }
          if (!selectedVoice) {
            selectedVoice = voices.find(voice => voice.lang.startsWith('en-US'));
          }

          utterance.voice = selectedVoice;
          utterance.pitch = 1;
          utterance.rate = 1;
          window.speechSynthesis.speak(utterance);
        } else {
          alert('Sorry, your browser does not support Text-to-Speech.');
        }
      }

      document.addEventListener('DOMContentLoaded', function() {
        console.log("[Frontend] Dialog loaded. Requesting words...");
        try {
          if ('speechSynthesis' in window) {
              getVoices();
              if (speechSynthesis.onvoiceschanged !== undefined) {
                  speechSynthesis.onvoiceschanged = getVoices;
              }
          }

          google.script.run
            .withSuccessHandler(initializeReview)
            .withFailureHandler(showError)
            .getWordsDueForReview();

          document.body.addEventListener('click', function(event) {
            const targetId = event.target.id;
            const target = event.target;

            if (target.classList.contains('srs-btn')) {
              if (targetId === 'again-btn') submitReview('Again');
              else if (targetId === 'hard-btn') submitReview('Hard');
              else if (targetId === 'good-btn') submitReview('Good');
              else if (targetId === 'easy-btn') submitReview('Easy');
              return;
            }
            
            switch(targetId) {
              case 'show-answer-btn':
                document.getElementById('word-card').classList.remove('is-initial');
                return;
              // case 'play-scramble-btn':
              //   playScramble();
              //   return;
              case 'manual-set-btn':
                const input = document.getElementById('manual-days-input');
                const days = parseInt(input.value, 10);
                if (days && days > 0) {
                  submitReview(days);
                  input.value = '';
                }
                return;
              case 'review-more-btn':
                fetchMoreWords();
                return;
            }

            const pronunciationButton = target.closest('.play-button');
            const ttsButton = target.closest('.tts-button');
            const addWordButton = target.closest('.add-word-btn');

            if (pronunciationButton) {
              const audioUrl = pronunciationButton.dataset.audioUrl;
              if (audioUrl) playAudio(audioUrl);
            } else if (ttsButton) {
                const textToSpeak = ttsButton.dataset.textToSpeak;
                if (textToSpeak) speakText(textToSpeak);
            } else if (addWordButton) {
                const button = addWordButton;
                const wordToAdd = button.dataset.word;
                button.disabled = true;
                button.textContent = 'Adding...';
                
                google.script.run
                    .withSuccessHandler(message => {
                        showToast(message);
                        button.textContent = '✓ Added';
                    })
                    .withFailureHandler(showError)
                    .addNewWord(wordToAdd);
            }
          });


          const writingCb = document.getElementById('writing-cb');
          const speakingCb = document.getElementById('speaking-cb');
          const difficultySelect = document.getElementById('difficulty-select');

          function sendMetadataUpdate() {
              const wordData = wordsToReview[currentWordIndex];
              if (!wordData) return;
              google.script.run
                  .withFailureHandler(showError)
                  .updateWordMetadata({
                      row: wordData.row,
                      writing: writingCb.checked ? 1 : 0,
                      speaking: speakingCb.checked ? 1 : 0,
                      difficulty: parseInt(difficultySelect.value, 10)
                  });
          }
          writingCb.addEventListener('change', sendMetadataUpdate);
          speakingCb.addEventListener('change', sendMetadataUpdate);
          difficultySelect.addEventListener('change', sendMetadataUpdate);  
          
          const settingsModal = document.getElementById('settings-modal');
          const settingsBtn = document.getElementById('settings-btn');
          const closeBtn = document.querySelector('.close-btn');
          const voiceSelector = document.getElementById('voice-selector');

          settingsBtn.onclick = () => settingsModal.style.display = "flex";
          closeBtn.onclick = () => settingsModal.style.display = "none";
          window.onclick = (event) => {
            if (event.target == settingsModal) {
              settingsModal.style.display = "none";
            }
          }
          voiceSelector.onchange = () => {
            const selectedName = voiceSelector.selectedOptions[0].getAttribute('data-name');
            localStorage.setItem(VOICE_STORAGE_KEY, selectedName);
            speakText("This is the selected voice.");
          };

        } catch (e) {
          showError(e);
        }
      });

      function initializeReview(words) {
        console.log("[Frontend] Received words from backend:", words);
        try {
          wordsToReview = words;
          if (wordsToReview && wordsToReview.length > 0) {
            totalWordsInSession = wordsToReview.length;
            reviewedWords = 0;
            console.log("[Frontend] Words available. Starting review session.");
            reviewContainer.className = 'is-reviewing';
            updateProgressCounter();
            displayCurrentWord();
          } else {
            console.log("[Frontend] No words due for review. Showing complete screen.");
            reviewContainer.className = 'is-empty'; 
          }
        } catch (e) {
          showError(e);
        }
      }

      function displayCurrentWord() {
        try {
            if (currentWordIndex < wordsToReview.length) {
                const wordData = wordsToReview[currentWordIndex];
                console.log("[Frontend] Displaying word:", wordData.word);
                const wordCard = document.getElementById('word-card');
                wordCard.classList.add('is-initial');

                // --- 1. SETUP (Word, Buttons, Clear Display) ---
                document.getElementById('word-display').textContent = wordData.word;
                const answerDisplay = document.getElementById('answer-display');
                answerDisplay.innerHTML = '';
                answerDisplay.scrollTop = 0;

                const totalReviews = wordData.totalReviews || 0;
                let goodDays = (totalReviews < 3) ? [3, 7, 14][totalReviews] : 30;
                let easyDays = (totalReviews < 3) ? [7, 30, 90][totalReviews] : 180;
                const formatDays = (days) => days === 1 ? '1 day' : `${days} days`;

                document.getElementById('again-btn').innerHTML = `Again<small>Today</small>`;
                document.getElementById('hard-btn').innerHTML = `Hard<small>1 day</small>`;
                document.getElementById('good-btn').innerHTML = `Good<small>${formatDays(goodDays)}</small>`;
                document.getElementById('easy-btn').innerHTML = `Easy<small>${formatDays(easyDays)}</small>`;

                // --- 2. SET METADATA CONTROLS ---
                document.getElementById('writing-cb').checked = (wordData.writing == 1);
                document.getElementById('speaking-cb').checked = (wordData.speaking == 1);
                document.getElementById('difficulty-select').value = wordData.difficulty || 0;

                const pronunciationGroup = document.getElementById('pronunciation-group');
                pronunciationGroup.innerHTML = '';


                const appendStrongText = (parent, label, text) => {
                    if (text && text !== '—') {
                        const p = document.createElement('p');
                        p.innerHTML = `<strong>${label}:</strong> ${text}`;
                        parent.appendChild(p);
                    }
                };

                const escapeHtmlAttr = (str) => {
                    return str
                        .replace(/&/g, "&amp;")
                        .replace(/"/g, "&quot;")
                        .replace(/'/g, "&#039;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;");
                };

                // MODIFIED: This function now adds TTS buttons to the "General Examples" list.
                const appendList = (parent, label, text, canAddWords) => {
                    if (canAddWords === undefined) {
                        canAddWords = false;
                    }
                    if (text && text.trim() && text !== '—') {
                        const div = document.createElement('div');
                        let html = `<strong>${label}:</strong><ul>`;
                        text.split('\n').forEach(itemText => {
                            if (itemText) {
                                const cleanText = itemText.replace(/• /g, '').trim();

                                // --- START OF MODIFICATION ---
                                // Use a regular expression to remove the part of speech in parentheses
                                // for the data-word attribute. This handles cases like "elusion (noun)"
                                // and multi-word phrases correctly.
                                const wordToAdd = cleanText.replace(/\s\(.*\)$/, '').trim();
                                const safeWordToAdd = escapeHtmlAttr(wordToAdd);
                                // --- END OF MODIFICATION ---

                                html += `<li>${cleanText}`;

                                if (label === 'General Examples') {
                                    html += ` <button class="tts-button" title="Read example aloud" data-text-to-speak="${safeWordToAdd}">${speakerIconSvg}</button>`;
                                }

                                if (canAddWords) {
                                    // **MODIFIED**: Use the cleaned 'wordToAdd' for the button's data.
                                    html += ` <button class="add-word-btn" title="Add &quot;${safeWordToAdd}&quot; to your list" data-word="${safeWordToAdd}">+</button>`;
                                }
                                html += `</li>`;
                            }
                        });
                        html += '</ul>';
                        div.innerHTML = html;
                        parent.appendChild(div);
                    }
                };

                // --- 3. RENDER PRONUNCIATION (NEW MULTI-PART-OF-SPEECH VERSION) ---
                const encodedWord = encodeURIComponent(wordData.word.toLowerCase());

                const renderPronunciations = (region, dataString) => {
                    console.log(region , dataString)
                    if (!dataString || dataString === '—') return;

                    const lines = dataString.split('\n').filter(line => line.trim());
                    lines.forEach((line, index) => {
                        const parts = line.split(':');
                        if (parts.length < 2) return;

                        const pos = parts[0].trim();
                        const ipa = parts.slice(1).join(':').trim();
                        if (ipa === '—') return;

                        // This is a best-effort guess for the audio file URL.
                        // Many services use _1, _2, etc., for multiple pronunciations.
                        const audioSuffix = `_${index + 1}`;
                        const audioUrl = `https://ssl.gstatic.com/dictionary/static/sounds/oxford/${encodedWord}--_${region.toLowerCase()}${audioSuffix}.mp3`;
                        console.log(`[Frontend] Url: "${audioUrl}"`)

                        const span = document.createElement('span');
                        span.innerHTML = `<strong>${region.toUpperCase()} (${pos}):</strong> ${ipa}`;
                        
                        const button = document.createElement('button');
                        button.className = `play-button play-button-${region.toLowerCase()}`;
                        button.innerHTML = speakerIconSvg;
                        button.dataset.audioUrl = audioUrl;
                        
                        span.appendChild(button);
                        pronunciationGroup.appendChild(span);
                    });
                };

                renderPronunciations('gb', wordData.ukPronunciation);
                renderPronunciations('us', wordData.usPronunciation);

                // if ((wordData.ukPronunciation && wordData.ukPronunciation !== '—') ||
                //     (wordData.usPronunciation && wordData.usPronunciation !== '—')) {

                //     const encodedWord = encodeURIComponent(wordData.word.toLowerCase());
                //     const localSpeakerIconSvg = `<svg viewBox="0 0 24 24" fill="currentColor" style="display: block; width: 100%; height: 100%;"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg>`;

                //     if (wordData.ukPronunciation && wordData.ukPronunciation !== '—') {
                //         const ukAudioUrl = `https://ssl.gstatic.com/dictionary/static/sounds/oxford/${encodedWord}--_gb_1.mp3`;
                //         const ukSpan = document.createElement('span');
                //         ukSpan.innerHTML = `<strong>UK:</strong> ${wordData.ukPronunciation}`;
                //         const ukButton = document.createElement('button');
                //         ukButton.className = 'play-button play-button-uk';
                //         ukButton.innerHTML = localSpeakerIconSvg;
                //         ukButton.dataset.audioUrl = ukAudioUrl;
                //         ukSpan.appendChild(ukButton);
                //         pronunciationGroup.appendChild(ukSpan);
                //     }

                //     if (wordData.usPronunciation && wordData.usPronunciation !== '—') {
                //         const usAudioUrl = `https://ssl.gstatic.com/dictionary/static/sounds/oxford/${encodedWord}--_us_1.mp3`;
                //         const usSpan = document.createElement('span');
                //         usSpan.innerHTML = `<strong>US:</strong> ${wordData.usPronunciation}`;
                //         const usButton = document.createElement('button');
                //         usButton.className = 'play-button play-button-us';
                //         usButton.innerHTML = localSpeakerIconSvg;
                //         usButton.dataset.audioUrl = usAudioUrl;
                //         usSpan.appendChild(usButton);
                //         pronunciationGroup.appendChild(usSpan);
                //     }
                // }


                // --- 4. RENDER PART OF SPEECH ---
                if (wordData.partOfSpeech && wordData.partOfSpeech !== '—') {
                    const p = document.createElement('p');
                    p.innerHTML = `<strong>Part of Speech:</strong> ${wordData.partOfSpeech}`;
                    answerDisplay.appendChild(p);
                }

                // --- 5. RENDER MEANINGS & DEFINITION EXAMPLES ---
                const meaningsTitle = document.createElement('strong');
                meaningsTitle.textContent = 'Meanings & Examples:';
                answerDisplay.appendChild(meaningsTitle);

                const definitionsParsed = parseMultiPartSpeechData(wordData.definitions);
                const persianParsed = parseMultiPartSpeechData(wordData.persianTranslations);
                const defExamplesParsed = parseMultiPartSpeechData(wordData.definitionExamples);

                definitionsParsed.forEach((section, posIndex) => {
                    if (section.pos) {
                        const posHeader = document.createElement('h4');
                        posHeader.className = 'pos-header';
                        posHeader.textContent = section.pos;
                        answerDisplay.appendChild(posHeader);
                    }
                    section.items.forEach((def, itemIndex) => {
                        const block = document.createElement('div');
                        block.className = 'meaning-block';
                        
                        const defP = document.createElement('p');
                        defP.className = 'definition';
                        defP.textContent = def.replace(/• /g, '');
                        block.appendChild(defP);

                        const persianText = (persianParsed[posIndex]?.items[itemIndex] || '').replace(/• /g, '');
                        const exampleText = (defExamplesParsed[posIndex]?.items[itemIndex] || '').replace(/• /g, '');
                        const safeExampleText = exampleText.replace(/"/g, '&quot;');

                        if (persianText) {
                            const persianP = document.createElement('p');
                            persianP.className = 'persian';
                            persianP.textContent = persianText;
                            block.appendChild(persianP);
                        }
                        if (exampleText) {
                            const exP = document.createElement('p');
                            exP.className = 'example';
                            exP.innerHTML = `${exampleText} <button class="tts-button" title="Read example aloud" data-text-to-speak="${safeExampleText}">${speakerIconSvg}</button>`;
                            block.appendChild(exP);
                        }
                        answerDisplay.appendChild(block);
                    });
                });
                answerDisplay.appendChild(document.createElement('hr'));


                // --- 6. RENDER GENERAL EXAMPLES ---
                const genExParsed = parseMultiPartSpeechData(wordData.generalExamples);
                if (genExParsed[0]?.items.length > 0 && genExParsed[0].items[0] !== '• —') {
                    const genExTitle = document.createElement('strong');
                    genExTitle.textContent = 'General Examples:';
                    answerDisplay.appendChild(genExTitle);
                    
                    const genExPersianParsed = parseMultiPartSpeechData(wordData.generalExamplesPersian);

                    genExParsed.forEach((section, posIndex) => {
                        if (section.pos) {
                            const posHeader = document.createElement('h4');
                            posHeader.className = 'pos-header';
                            posHeader.textContent = section.pos;
                            answerDisplay.appendChild(posHeader);
                        }
                        section.items.forEach((engExample, itemIndex) => {
                            const block = document.createElement('div');
                            block.className = 'meaning-block';
                            
                            const engText = engExample.replace(/• /g, '');
                            const safeEngText = engText.replace(/"/g, '&quot;');
                            const engP = document.createElement('p');
                            engP.className = 'example';
                            engP.innerHTML = `${engText} <button class="tts-button" title="Read example aloud" data-text-to-speak="${safeEngText}">${speakerIconSvg}</button>`;
                            block.appendChild(engP);
                            
                            const perText = (genExPersianParsed[posIndex]?.items[itemIndex] || '').replace(/• /g, '');
                            if (perText) {
                                const perP = document.createElement('p');
                                perP.className = 'persian-example';
                                perP.textContent = perText;
                                block.appendChild(perP);
                            }
                            answerDisplay.appendChild(block);
                        });
                    });
                    answerDisplay.appendChild(document.createElement('hr'));
                }

                // --- 7. RENDER SIMPLE LISTS (SYNONYMS, NOTES, ETC.) ---
                const renderSimpleList = (label, dataString, options = {}) => {
                    const parsedData = parseMultiPartSpeechData(dataString);
                    if (!parsedData[0]?.items.length || parsedData[0].items[0].includes('—')) return;

                    const container = document.createElement('div');
                    container.innerHTML = `<strong>${label}:</strong>`;
                    
                    parsedData.forEach(section => {
                        if (section.pos) {
                            const posHeader = document.createElement('h5');
                            posHeader.className = 'pos-header-small';
                            posHeader.textContent = section.pos;
                            container.appendChild(posHeader);
                        }
                        const ul = document.createElement('ul');
                        section.items.forEach(itemText => {
                            const li = document.createElement('li');
                            const cleanText = itemText.replace(/• /g, '').trim();
                            li.innerHTML = cleanText;
                            if (options.addable) {
                                const wordToAdd = cleanText.replace(/\s\(.*\)$/, '').trim();
                                const safeWord = escapeHtmlAttr(wordToAdd);
                                li.innerHTML += ` <button class="add-word-btn" title="Add '${safeWord}' to list" data-word="${safeWord}">+</button>`;
                            }
                            ul.appendChild(li);
                        });
                        container.appendChild(ul);
                    });
                    answerDisplay.appendChild(container);
                };

                renderSimpleList('Synonyms', wordData.synonyms, { addable: true });
                renderSimpleList('Antonyms', wordData.antonyms, { addable: true });
                renderSimpleList('Notes', wordData.notes);
                renderSimpleList('Word Family', wordData.wordFamily, { addable: true });


                // --- 8. RENDER DICTIONARY LINKS ---
                const linksContainer = document.createElement('div');
                linksContainer.className = 'dictionary-links';
                if (wordData.cambridgeUrl) {
                    const link = document.createElement('a');
                    link.href = wordData.cambridgeUrl;
                    link.target = '_blank';
                    link.innerHTML = '📖<span>Cambridge</span>';
                    linksContainer.appendChild(link);
                }
                if (wordData.oxfordUrl) {
                    const link = document.createElement('a');
                    link.href = wordData.oxfordUrl;
                    link.target = '_blank';
                    link.innerHTML = '📚<span>Oxford</span>';
                    linksContainer.appendChild(link);
                }
                if (linksContainer.hasChildNodes()) {
                    answerDisplay.appendChild(linksContainer);
                }
              
                requestAnimationFrame(() => {
                    answerDisplay.scrollTop = 0;
                    window.scrollTo(0, 0);
                });

            } else {
                console.log("[Frontend] No more words in the current queue. Showing complete screen.");
                reviewContainer.className = 'is-complete';
            }
        } catch (e) {
            showError(e);
        }
    }

      function fetchMoreWords() {
        const btn = document.getElementById('review-more-btn');
        btn.disabled = true;
        btn.textContent = 'Loading...';
        console.log("[Frontend] Fetching 10 more words...");
        google.script.run
          .withSuccessHandler(appendMoreWords)
          .withFailureHandler(showError)
          .getFutureWords(10);
      }

      function appendMoreWords(newWords) {
        console.log("[Frontend] Received future words:", newWords);
        const btn = document.getElementById('review-more-btn');
        btn.disabled = false;
        btn.textContent = 'Review 10 More Words';

        if (newWords && newWords.length > 0) {
          wordsToReview.push(...newWords);
          totalWordsInSession = wordsToReview.length;
          reviewContainer.className = 'is-reviewing';
          updateProgressCounter();
          setTimeout(() => {
            displayCurrentWord();
          }, 0);
        } else {
          document.getElementById('session-complete').innerHTML = '<h2>All Done!</h2><p>You have reviewed every word in your list. Great job!</p>';
        }
      }
      
      function playScramble() {
        const wordData = wordsToReview[currentWordIndex];
        const hint = (wordData.definitions[0] || '').replace(/• /g, '');
        google.script.run.openScramblePuzzle(wordData.word, hint);
      }

      function submitReview(difficulty) {
        const wordData = wordsToReview[currentWordIndex];
        console.log(`[Frontend] Submitting review for "${wordData.word}" with difficulty: ${difficulty}`);
        
        google.script.run
            .withFailureHandler(showError)
            .updateWordReview({
                row: wordData.row,
                difficulty: difficulty,
                reviewCount: wordData.reviewCount,
                totalReviews: wordData.totalReviews
            });

        if (difficulty === 'Again') {
          wordsToReview.push(wordData);
          totalWordsInSession = wordsToReview.length;
        } else {
          reviewedWords++;
        }

        currentWordIndex++;
        updateProgressCounter();

        document.getElementById('answer-display').scrollTop = 0;
        setTimeout(() => {
          document.getElementById('answer-display').scrollTop = 0;
        }, 10);
        displayCurrentWord();
      }

      function showError(error) {
        console.error("Dialog error:", error);

        reviewContainer.className = 'has-error';
        document.getElementById('error-message').textContent = 'Error: ' + (error.message || error);
      }

      function showToast(message) {
        let toast = document.querySelector('.toast');
        if (!toast) {
          toast = document.createElement('div');
          toast.className = 'toast';
          document.body.appendChild(toast);
        }
        toast.textContent = message;
        
        setTimeout(() => toast.classList.add('show'), 10);

        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
              if (toast) document.body.removeChild(toast);
            }, 500);
        }, 3000);
      }
    </script>
  </body>
</html>
